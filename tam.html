<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°</title>
<style>
/* ===================================
   CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢ (Redeem)
   ‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏£‡∏°‡∏ó‡πà‡∏≤ (#003366) ‡πÅ‡∏•‡∏∞‡∏™‡∏µ‡∏ó‡∏≠‡∏á (#FFC107)
   =================================== */
:root {
    --college-primary: #003366;
    --college-accent: #FFC107;
}
body { 
    font-family: Kanit, sans-serif; 
    background: #F0F4F8; 
    padding-top: 70px; 
}
.container { 
    width: 800px; 
    background: #ffffff; 
    padding: 30px; 
    border-radius: 12px; 
    box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
    text-align: center; 
    margin-top: 20px;
    margin-bottom: 40px;
}
.main-container {
  margin-top: 20px;
  margin-bottom: 40px;
}
h1, h2, h3 { 
    color: var(--college-primary); 
    font-weight: 700; 
    margin-bottom: 20px;
}
.bg-college-primary { background-color: var(--college-primary) !important; }
.Font { 
    font-size: 28px; 
    color: white !important; 
    font-weight: 700; 
    display: flex; 
    align-items: center; 
}
.logo-school { 
    width: 40px; 
    height:auto; 
    margin-right: 10px; 
    margin-left: 0; 
    filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
}

/* Subject Card */
.card { 
    border: 1px solid #D1D9E6; 
    padding: 15px; 
    margin-bottom: 15px; 
    border-radius: 8px; 
    text-align: left; 
    background: #F9FBFC; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    border-left: 5px solid var(--college-primary);
}
.card h5 { color: var(--college-primary); font-weight: 700; margin-bottom: 5px; }
.card p { margin-bottom: 5px; font-size: 0.95rem; }

/* Redeem Button */
.redeem-btn { 
    background: var(--college-accent); 
    color: var(--college-primary); 
    border: none; 
    font-weight: 700;
    padding: 8px 15px;
    border-radius: 6px;
    transition: 0.3s;
}
.redeem-btn:hover { background: #E6B000; }
.redeem-btn:disabled { opacity: 0.6; cursor: not-allowed; }

/* Sidebar (Offcanvas) enhancements */
.offcanvas-header { background-color: var(--college-primary); color: white; }
.offcanvas-title { font-weight: 700; }
.list-group-item { border-left: 5px solid transparent; }
.list-group-item:hover { background-color: #f8f9fa; }
.list-group-item .fw-bold { color: var(--college-accent); }
.nav-link.active { font-weight: 600; color: var(--college-accent) !important; }

@media (max-width: 450px) {
    .Font {
        font-size: 22px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏≠‡∏á Navbar */
    }
    .logo-school {
        width: 30px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÉ‡∏ô Navbar */
    }
    .container h2 {
        font-size: 1.5rem; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏ô Main Container */
    }
}

@media (max-width:600px) {
  .container { width:100%; border-radius:0; box-shadow:none; padding: 20px; }
  body { padding-top: 105px; } /* üëà ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏õ‡πá‡∏ô 105px ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
}
</style>
</head>
<body>

<nav class="navbar navbar-dark bg-college-primary fixed-top">
  <div class="container-fluid">
    <div class="Font">
      <img src="img/‡∏ï‡∏£‡∏≤.png" class="logo-school" alt="College Logo">
      ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
    </div>

    <div class="d-flex align-items-center ms-auto">
      <span id="userText" class="text-white me-2"></span>
      <button id="loginBtn" class="btn btn-warning btn-sm text-dark fw-bold me-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      <button class="navbar-toggler" id="menuBtn" style="display:none;"
        type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasDarkNavbar">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>

    <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="offcanvasDarkNavbar">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
      </div>

      <div class="offcanvas-body">

        <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">

          <li class="nav-item">
            <a class="nav-link active">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a>
          </li>

          <ol class="list-group list-group-numbered">

            <li class="list-group-item d-flex justify-content-between align-items-start">
              <div class="ms-2 me-auto">
                <div class="fw-bold">‡∏Ç‡∏≤‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>
                ‡∏Ç‡∏≤‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î : <span id="missCount">0</span>
              </div>
            </li>

            <li class="list-group-item d-flex justify-content-between align-items-start">
              <div class="ms-2 me-auto">
                <div class="fw-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î : <span id="joinCount">0</span>
              </div>
            </li>

            <li class="list-group-item d-flex justify-content-between align-items-start">
              <div class="ms-2 me-auto">
                <div class="fw-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°/‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</div>
                ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏° : <span id="pointCount">0</span>
              </div>
            </li>

            <li class="nav-item mt-2">
              <a class="nav-link active" href="tam.html">‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏¥‡∏ï‡∏û‡∏¥‡∏™‡∏±‡∏¢</a>
            </li>
            <li class="nav-item mt-2">
              <a id="backBtn" class="nav-link" href="#">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
            </li>
          </ol>
        
        </ul>

        <div class="mt-4 pt-4 border-top">
          <button id="logoutBtn" class="btn btn-outline-danger w-100" onclick="logout()" style="display:none;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

      </div>
    </div>

  </div>
</nav>

<div class="container main-container">
  
  <h2>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°</h2>
  
  <div class="text-start mb-4 p-3 bg-light rounded shadow-sm border border-primary">
    <h3>‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="points" class="text-success fw-bold">0.0</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
  </div>

  <h3 class="text-start">‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏•‡∏Å</h3>

  <div id="subjectContainer" class="text-start">
    </div>

  <hr class="my-4">

  <h3 class="text-start">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°</h3>
  <ul id="history" class="list-group list-group-flush text-start">
    </ul>

</div>

<script src="storage.js"></script>
<script src="auth.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<script>
const studentId = localStorage.getItem("student");
if(!studentId){
  alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°");
  window.location.href = "login.html";
}

// ‚≠ê Sidebar ‡πÅ‡∏•‡∏∞ Navbar (‡∏°‡∏≤‡∏à‡∏≤‡∏Å index.html)
function updateStats(){
  if (!studentId) return;

  const regs = JSON.parse(localStorage.getItem("registrations") || "{}");
  const missed = JSON.parse(localStorage.getItem("missedEvents") || "{}");
  const redeemLogs = JSON.parse(localStorage.getItem("redeemLogs") || "[]");
  const subjects = JSON.parse(localStorage.getItem("subjects") || "[]");

  let joinCount = 0;
  Object.keys(regs).forEach(date=>{
    regs[date].forEach(r=>{
      if(r.startsWith(studentId + "_")) joinCount++;
    });
  });

  // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  let totalEarnedPoints = joinCount * 0.5; 

  // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (‡∏´‡∏±‡∏Å‡∏≠‡∏≠‡∏Å)
  let redeemedPoints = 0;
  redeemLogs.filter(log => log.studentID === studentId).forEach(log => {
    const subject = subjects.find(s => s.code === log.subjectCode);
    if (subject) {
      redeemedPoints += subject.points;
    }
  });

  // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ï‡πâ‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
  let finalPoints = totalEarnedPoints - redeemedPoints;
  if (finalPoints < 0) finalPoints = 0; 
  
  localStorage.setItem("points_" + studentId, finalPoints.toFixed(1));

  document.getElementById("joinCount").innerText = joinCount;
  document.getElementById("missCount").innerText = Object.keys(missed).filter(k => k.startsWith(studentId + "_")).length;
  document.getElementById("pointCount").innerText = finalPoints.toFixed(1);

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
  document.getElementById("points").innerText = finalPoints.toFixed(1);
}

function checkLoginStatus(){
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const menuBtn = document.getElementById("menuBtn");

    if (studentId) {
        const students = JSON.parse(localStorage.getItem("students") || "[]");
        const stu = students.find(s => s.id === studentId);
        const fullname = stu ? stu.name : studentId;

        document.getElementById("userText").innerText = "üëã " + fullname;

        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        menuBtn.style.display = "inline-block";
        updateStats();
    } else {
        document.getElementById("userText").innerText = "";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        menuBtn.style.display = "none";
    }
}

function logout(){
  localStorage.removeItem("student");
  window.location.href = "login.html";
}
document.getElementById("backBtn").onclick = () => {
    if (history.length > 1) {
        history.back();
    } else {
        window.location.href = "index.html";
    }
  };


/* =======================
   ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°
======================= */
function renderSubjects(){
  const subjectContainer = document.getElementById("subjectContainer");
  subjectContainer.innerHTML = "";
  const subjects = JSON.parse(localStorage.getItem("subjects") || "[]");
  const studentCurrentPoints = parseFloat(localStorage.getItem(`points_${studentId}`) || "0");

  if(subjects.length === 0){
    subjectContainer.innerHTML = "<p class='text-muted'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏•‡∏Å‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>";
    return;
  }
  
  subjects.forEach(s => {
    const card = document.createElement("div");
    card.className = "card mb-3";
    
    const isRedeemed = isSubjectRedeemed(studentId, s.code);
    const canRedeem = studentCurrentPoints >= s.points && !isRedeemed;
    
    card.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5>${s.name} (${s.code})</h5>
          <p class="text-muted">‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°: <strong>${s.points}</strong> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
        </div>
        <button class="redeem-btn" 
                onclick="redeemSubject('${s.code}', '${s.name}', ${s.points})"
                ${!canRedeem || isRedeemed ? 'disabled' : ''}>
          ${isRedeemed ? '‡πÅ‡∏•‡∏Å‡πÅ‡∏•‡πâ‡∏ß' : (canRedeem ? '‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°!' : '‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠')}
        </button>
      </div>
    `;
    subjectContainer.appendChild(card);
  });
}

function isSubjectRedeemed(studentID, subjectCode){
    const logs = JSON.parse(localStorage.getItem("redeemLogs") || "[]");
    return logs.some(log => log.studentID === studentID && log.subjectCode === subjectCode);
}

function redeemSubject(code, name, cost){
    let points = parseFloat(localStorage.getItem(`points_${studentId}`) || "0");
    
    if(points < cost){
        alert("‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ");
        return;
    }
    
    if(isSubjectRedeemed(studentId, code)){
        alert("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß");
        return;
    }

    if(confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ ${cost} ‡πÅ‡∏ï‡πâ‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ ${name} (${code}) ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)){
        // 1. ‡∏´‡∏±‡∏Å‡πÅ‡∏ï‡πâ‡∏°
        points -= cost;
        localStorage.setItem(`points_${studentId}`, points.toFixed(1));
        
        // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å
        const historyKey = "history_" + studentId;
        let history = JSON.parse(localStorage.getItem(historyKey) || "[]");
        const today = new Date().toLocaleDateString('th-TH');
        const entry = { date: today, reward: name, cost: cost, code: code };
        history.push(entry);
        localStorage.setItem(historyKey, JSON.stringify(history));

        // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Log ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö admin
        let logs = JSON.parse(localStorage.getItem("redeemLogs") || "[]");
        logs.push({
            studentID: studentId,
            subjectCode: code,
            subjectName: name,
            cost: cost,
            date: today
        });
        localStorage.setItem("redeemLogs", JSON.stringify(logs));

        // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
        renderHistory();
        updateStats(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏ô sidebar ‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        renderSubjects(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏° disabled
        alert("‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úî");
    }
}

function renderHistory(){
    const historyDisplay = document.getElementById("history");
    historyDisplay.innerHTML = "";
    const historyKey = "history_" + studentId;
    const history = JSON.parse(localStorage.getItem(historyKey) || "[]").reverse(); // ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô

    if(history.length === 0){
        historyDisplay.innerHTML = "<li class='list-group-item text-center text-muted'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°</li>";
        return;
    }

    history.forEach(item => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `
            <span>${item.date} - ‡πÅ‡∏•‡∏Å: <strong>${item.reward}</strong> (${item.code})</span>
            <span class="badge bg-danger">‡πÉ‡∏ä‡πâ ${item.cost} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
        `;
        historyDisplay.appendChild(li);
    });
}

window.onload = () => {
  checkLoginStatus();
  renderSubjects();
  renderHistory();
};

</script>
</body>
</html>