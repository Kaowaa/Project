<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (Admin)</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/material_blue.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/th.js"></script>
<style>
/* ===================================
   CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢ (Admin)
   ‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏£‡∏°‡∏ó‡πà‡∏≤ (#003366) ‡πÅ‡∏•‡∏∞‡∏™‡∏µ‡∏ó‡∏≠‡∏á (#FFC107)
   =================================== */
:root {
    --college-primary: #003366;
    --college-accent: #FFC107;
}

body { 
    background: #F0F4F8; 
    font-family: "Kanit", sans-serif; 
    padding: 0; 
    margin-top: 70px;
}

/* Navbar */
.bg-college-primary { background-color: var(--college-primary) !important; }
.Font { 
    font-size: 28px; 
    color: white !important; 
    font-weight: 700; 
    display: flex; 
    align-items: center; 
}
.logo-school { 
    width: 40px; 
    height:auto; 
    margin-right: 10px; 
    margin-left: 0; 
    filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
}

/* Layout and Containers */
.main-layout { 
    display: flex; 
    margin: 20px auto; 
    padding: 20px; 
    gap: 20px; 
    max-width: 1200px;
    width: 95%; 
    box-sizing: border-box; 
    align-items: flex-start;
}

h3, h5 { 
    text-align: center; 
    font-weight: 700; 
    color: var(--college-primary); 
    margin-bottom: 20px; 
}

/* Sidebar (Menu) */
.sidebar { 
    width: 250px; 
    background: #fff; 
    padding: 20px; 
    border-radius: 8px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
    display:flex; 
    flex-direction:column; 
    gap:10px; 
}
.sidebar button { 
    border: none; 
    border-radius: 8px; 
    padding: 12px; 
    font-weight: 600; 
    background: #EAF0F6;
    color: var(--college-primary); 
    transition: 0.3s; 
    text-align: left;
}
.sidebar button:hover { 
    background: #DCE3EA; 
}
.sidebar button.active { 
    background: var(--college-primary); 
    color: var(--college-accent); 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.sidebar .logout-btn { 
    background: #dc3545; 
    color: white; 
    margin-top: 20px;
}

/* Main Content Area & Forms */
.content { 
    flex: 1; 
    background: #fff; 
    padding: 30px; 
    border-radius: 8px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
    min-height: 400px; 
    display: block; 
}
#adminLogin {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
}

.form-control, .form-select { border-radius: 6px; }
.btn-primary, .btn-success { background-color: var(--college-primary); border-color: var(--college-primary); font-weight: 600;}
.btn-primary:hover, .btn-success:hover { background-color: #002B5C; border-color: #002B5C; }
.btn-info { 
    background-color: var(--college-accent) !important; 
    border-color: var(--college-accent) !important; 
    color: var(--college-primary) !important; 
    font-weight: 600;
}
.btn-info:hover { background-color: #E6B000 !important; border-color: #E6B000 !important; }

.list-group-item { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    border-radius: 8px !important;
    margin-bottom: 8px;
    background-color: #f7f9fb;
    border-left: 5px solid var(--college-primary);
}

/* Modals */
.modal-content { border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.modal-header { 
    background-color: var(--college-primary); 
    color: white; 
    border-bottom: none; 
    border-top-left-radius: 12px; 
    border-top-right-radius: 12px; 
}
.modal-title 
{ font-weight: 700; 
  filter: invert(1) grayscale(100%) brightness(200%);
}

/* Stats Box in Student Detail Modal */
.stat-box { 
    background: #fff; 
    padding: 15px 10px; 
    border-radius: 8px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.stat-box strong { 
    display: block; 
    font-size: 1.8rem; 
    color: var(--college-primary); 
    font-weight: 700;
}
.stat-box.bg-success-subtle strong { color: #198754; }
.stat-box.bg-danger-subtle strong { color: #dc3545; }
.stat-box.bg-info-subtle strong { color: var(--college-accent); }


@media (max-width:992px) {
  .main-layout { flex-direction: column; }
  .sidebar { width: 100%; margin-bottom: 20px; }
}
@media (max-width:600px) {  
  .container { width:100%; border-radius:0; box-shadow:none; }
}
</style>
</head>
<body>

<nav class="navbar navbar-dark bg-college-primary fixed-top">
  <div class="container-fluid">
    <div class="Font">
      <img src="‡∏ï‡∏£‡∏≤.png" class="logo-school" alt="College Logo">
      ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (Admin)
    </div>
    <div class="d-flex align-items-center">
      <span id="userText" class="text-white me-2"></span>
      <button class="btn btn-danger btn-sm" onclick="adminLogout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </div>
</nav>

<div class="main-layout">

  <div class="sidebar">
    <div class="text-center"><h4><strong>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≤‡∏á‡πÜ</strong></h4></div>
    <button id="modeActivity" class="btn btn-primary">üìÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
    <button id="modeStudent" class="btn btn-success">üë®‚Äçüéì ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
    <button id="modeSubject" class="btn btn-secondary">üìï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏•‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</button>

  </div>

  <div class="content" id="adminLogin">
    <h3>üõ† ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (Admin)</h3>
    <hr>
    <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
    <input id="adminUser" class="form-control mb-2" placeholder="admin">
    <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
    <input id="adminPass" type="password" class="form-control mb-2" placeholder="8888">
    <button class="btn btn-primary w-100 mt-3" onclick="adminLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <a href="index.html" class="btn btn-outline-secondary w-100 mt-2">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
  </div>

  <div class="content" id="adminPanel" style="display:none;">
    <h5 class="fw-bold mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà</h5>
    <input id="eventTitle" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">
    <input id="eventDate" type="text" class="form-control mb-2" placeholder="‡∏ß‡∏ß/‡∏î‡∏î/‡∏õ‡∏õ‡∏õ‡∏õ">
    <div class="d-flex gap-2 mb-2">
      <div class="w-100">
        <label class="small text-muted">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
        <input id="eventStart" type="text" class="form-control" placeholder="--:--">
      </div>
      <div class="w-100">
        <label class="small text-muted">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
        <input id="eventEnd" type="text" class="form-control" placeholder="--:--">
      </div>
    </div>
    <select id="eventMode" class="form-select mb-3">
      <option value="register">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</option>
      <option value="notify">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
    </select>
    <button class="btn btn-success w-100 mb-3" onclick="addEvent()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>

    <hr>
    <h5 class="fw-bold mb-3">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å CSV</h5>
    <div class="d-flex gap-2 mb-2">
        <input type="file" id="eventCSV" accept=".csv" class="form-control">
<button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#eventCSVModal">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</button>    </div>
    <button class="btn btn-primary w-100 mb-3" onclick="importEventsCSV()">Import ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å CSV</button>

    <hr>
    <h5 class="fw-bold mb-3">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
    <button class="btn btn-info w-100 mb-3 text-white" onclick="downloadAllEventsReport()">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (CSV)</button>

    <hr>
    <h5 class="fw-bold mb-2">üìÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
    <ul id="eventList" class="list-group"></ul>
</div>

  <div class="content" id="subjectPanel" style="display:none;">
    <h5 class="fw-bold mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡∏°‡πà</h5>
    <input id="subjectName" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤">
    <input id="subjectCode" class="form-control mb-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤">
    <input id="subjectPoints" type="number" class="form-control mb-2" placeholder="‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ">
    <button class="btn btn-success w-100 mb-3" onclick="addSubject()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤</button>

    <hr>
    <h5 class="fw-bold mb-3">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏à‡∏≤‡∏Å CSV</h5>
    <div class="d-flex gap-2 mb-2">
        <input type="file" id="subjectCSV" accept=".csv" class="form-control">
<button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#subjectCSVModal">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</button>    </div>
    <button class="btn btn-primary w-100 mb-3" onclick="importSubjectsCSV()">Import ‡∏ß‡∏¥‡∏ä‡∏≤‡∏à‡∏≤‡∏Å CSV</button>

    <hr>
    <h5 class="fw-bold mb-3">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
    <button class="btn btn-info w-100 mb-3 text-white" onclick="downloadAllSubjectReport()">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤ (CSV)</button>

    <hr>
    <h5 class="fw-bold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
    <ul id="subjectList" class="list-group"></ul>
</div>

  <div class="content" id="studentPanel" style="display:none;">
    <h5 class="fw-bold mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h5>
    <input id="stdName" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
    <input id="stdId" class="form-control mb-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
    
    <select id="stdGrade" class="form-select mb-2">
        <option value="" selected disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option>
        <option value="‡∏õ‡∏ß‡∏ä.1">‡∏õ‡∏ß‡∏ä.1</option>
        <option value="‡∏õ‡∏ß‡∏ä.2">‡∏õ‡∏ß‡∏ä.2</option>
        <option value="‡∏õ‡∏ß‡∏ä.3">‡∏õ‡∏ß‡∏ä.3</option>
        <option value="‡∏õ‡∏ß‡∏™.1">‡∏õ‡∏ß‡∏™.1</option>
        <option value="‡∏õ‡∏ß‡∏™.2">‡∏õ‡∏ß‡∏™.2</option>
    </select>

    <select id="stdDept" class="form-select mb-2">
        <option value="" selected disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ --</option>
        <option value="‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Ñ‡πâ‡∏≤‡∏õ‡∏•‡∏µ‡∏Å">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Ñ‡πâ‡∏≤‡∏õ‡∏•‡∏µ‡∏Å</option>
        <option value="‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</option>
        <option value="‡πÅ‡∏ú‡∏ô‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î">‡πÅ‡∏ú‡∏ô‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î</option>
        <option value="‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
        <option value="‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡πà‡∏≤‡∏á‡∏Å‡∏•‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡πà‡∏≤‡∏á‡∏Å‡∏•‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</option>
        <option value="‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡πà‡∏≤‡∏á‡∏Å‡∏•‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á</option>
        <option value="‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡πà‡∏≤‡∏á‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡πà‡∏≤‡∏á‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå</option>
        <option value="‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á</option>
        <option value="‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå</option>
        <option value="‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</option>
        <option value="‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏≤‡∏°‡∏±‡∏ç-‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏≤‡∏°‡∏±‡∏ç-‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
    </select>

    <input id="stdDob" class="form-control mb-2" placeholder="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î" readonly>
    <button class="btn btn-success w-100 mb-3" onclick="addStudent()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>

    <hr>
    <h5 class="fw-bold mb-3">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å CSV</h5>
    <div class="d-flex gap-2 mb-2">
        <input type="file" id="studentCSV" accept=".csv" class="form-control">
        <button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#studentCSVModal">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</button>
    </div>
    <button class="btn btn-primary w-100 mb-3" onclick="importStudentsCSV()">Import ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å CSV</button>

    <hr>
    <h5 class="fw-bold mb-3">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h5>
    <button class="btn btn-info w-100 mb-3 text-white" onclick="downloadAllStudentsReport()">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (CSV)</button>

    <hr>
    <h5 class="fw-bold mb-2">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
    <ul id="studentList" class="list-group"></ul>
</div>

</div>

<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-xl"> <div class="modal-content">
      <div class="modal-header bg-college-primary text-white">
        <h5 class="modal-title" id="detailTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
            <div class="col-md-6">
                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> <span id="detailDate"></span></p>
                <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô:</strong> <span id="detailCount" class="badge bg-success">0</span> ‡∏Ñ‡∏ô</p>
            </div>
            <div class="col-md-6 text-end">
              <button id="downloadEventRegBtn" class="btn btn-outline-secondary btn-sm">üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>                
            </div>
        </div>
        
        <hr>
        <h6>üñºÔ∏è ‡πÅ‡∏ú‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠:</h6>
        <div id="imageGallery" class="row g-3">
            </div>
        
        <ul id="detailList" class="list-group mt-4" style="display:none;"></ul>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="subjectDetailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <p><strong>‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤:</strong> <span id="subCode"></span></p>
        <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤:</strong> <span id="subName"></span></p>
        <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÅ‡∏•‡∏Å:</strong> <span id="subCount"></span> ‡∏Ñ‡∏ô</p>
        <hr>
        <h6>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏•‡∏Å</h6>
        <ul id="subList"></ul>
      </div>

      <div class="modal-footer">
        <button class="btn btn-success me-auto" id="downloadSubjectRedeemBtn">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="studentDetailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: <span id="stuDetailName"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="row text-center mb-3">
            <div class="col-4">
                <div class="stat-box bg-success-subtle">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°<br><strong><span id="stuAttendedCount">0</span></strong> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
            </div>
            <div class="col-4">
                <div class="stat-box bg-danger-subtle">‡∏Ç‡∏≤‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°<br><strong><span id="stuMissedCount">0</span></strong> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
            </div>
            <div class="col-4">
                <div class="stat-box bg-info-subtle">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°<br><strong><span id="stuPointCount">0</span></strong> ‡πÅ‡∏ï‡πâ‡∏°</div>
            </div>
        </div>

        <hr>
        <h6>üìï ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏•‡πâ‡∏ß (<span id="stuRedeemTotal">0</span> ‡∏ß‡∏¥‡∏ä‡∏≤)</h6>
        <ul id="stuRedeemList" class="list-group"></ul>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="csvGuideModal" tabindex="-1" aria-labelledby="csvGuideModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="csvGuideModalLabel">üìö ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î **5 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå** ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:</p>
        <ol class="list-group list-group-numbered">
          <li class="list-group-item">**‡∏ä‡∏∑‡πà‡∏≠** (‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</li>
          <li class="list-group-item">**‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô** (‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô)</li>
          <li class="list-group-item">**‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô** (‡πÄ‡∏ä‡πà‡∏ô ‡∏°.4/1, ‡∏õ‡∏ß‡∏ä.1)</li>
          <li class="list-group-item">**‡πÅ‡∏ú‡∏ô‡∏Å/‡∏™‡∏≤‡∏¢** (‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏¥‡∏ó‡∏¢‡πå-‡∏Ñ‡∏ì‡∏¥‡∏ï, ‡∏ä‡πà‡∏≤‡∏á‡∏¢‡∏ô‡∏ï‡πå)</li>
          <li class="list-group-item">**‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î** (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd/mm/yy ‡∏´‡∏£‡∏∑‡∏≠ dd/mm/yyyy)</li>
        </ol>
        <hr>
        <p class="text-danger small fw-bold">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (Header Row):<br>
        `‡∏ä‡∏∑‡πà‡∏≠,‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô,‡πÅ‡∏ú‡∏ô‡∏Å,‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î`</p>
        <p class="text-success small fw-bold">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1:<br>
        `‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏Ç‡∏¢‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,12345,‡∏°.4/1,‡∏ß‡∏¥‡∏ó‡∏¢‡πå-‡∏Ñ‡∏ì‡∏¥‡∏ï,01/01/48`</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="eventCSVModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:</p>
        <div class="bg-light p-3 border rounded mb-3">
            <code>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà(‡∏õ‡∏õ‡∏õ‡∏õ-‡∏î‡∏î-‡∏ß‡∏ß),‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°,‡πÄ‡∏£‡∏¥‡πà‡∏°,‡∏à‡∏ö,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</code>
        </div>
        <h6>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ü‡∏¥‡∏•‡∏î‡πå:</h6>
        <ul>
            <li><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ‡∏Ñ.‡∏®. ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÄ‡∏ä‡πà‡∏ô <code>2025-02-15</code></li>
            <li><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ 2 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏≠ <code>register</code> (‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô) ‡∏´‡∏£‡∏∑‡∏≠ <code>notify</code> (‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå)</li>
        </ul>
        <h6>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</h6>
        <pre class="bg-dark text-warning p-2">2025-02-15,‡∏õ‡∏ê‡∏°‡∏ô‡∏¥‡πÄ‡∏ó‡∏®,08:30,12:00,register
2025-02-16,‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏Ñ‡∏£‡∏π,13:00,16:00,notify</pre>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="subjectCSVModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:</p>
        <div class="bg-light p-3 border rounded mb-3">
            <code>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤,‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤,‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ</code>
        </div>
        <h6>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</h6>
        <pre class="bg-dark text-warning p-2">‡∏ß‡∏¥‡∏ä‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢,TH101,50
‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå,MA102,100
‡∏ä‡πà‡∏≤‡∏á‡∏¢‡∏ô‡∏ï‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô,ME201,150</pre>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="studentCSVModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö 5 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:</p>
          <div class="bg-light p-3 border rounded mb-3">
              <code>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•,‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô,‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤,‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î</code>
          </div>
          <h6>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ü‡∏¥‡∏•‡∏î‡πå:</h6>
          <ul>
              <li><strong>‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î:</strong> ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö <code>‡∏ß‡∏ß ‡∏î‡∏î ‡∏õ‡∏õ‡∏õ‡∏õ</code> (‡πÄ‡∏ä‡πà‡∏ô 10082547)</li>
          </ul>
        <h6>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</h6>
        <pre class="bg-dark text-warning p-2">‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏î‡∏µ‡∏°‡∏≤‡∏Å,652010001,‡∏õ‡∏ß‡∏ä.1,‡∏ä‡πà‡∏≤‡∏á‡∏¢‡∏ô‡∏ï‡πå,15022549
‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡πÉ‡∏à‡∏î‡∏µ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏Å‡πà‡∏á,652010002,‡∏õ‡∏ß‡∏ä.1,‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ,20112548</pre>
      </div>
    </div>
  </div>
</div>
<script src="storage.js"></script>
<script src="calendar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<script>
  /* =======================
   ‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏° (Subjects) üÜï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
======================= */

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏à‡∏≤‡∏Å CSV
function importSubjectsCSV() {
    const file = document.getElementById("subjectCSV").files[0];
    if (!file) {
        alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        return;
    }

    const reader = new FileReader();
    reader.onload = e => {
        const lines = e.target.result.split(/\r?\n/);
        let subjects = JSON.parse(localStorage.getItem("subjects") || "[]");
        let added = 0;

        lines.forEach((line, i) => {
            if (i === 0 || !line.trim()) return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á

            const parts = line.split(",").map(x => x.trim().replace(/^"|"$/g, ''));
            if (parts.length < 3) return;

            const name = parts[0];
            const code = parts[1];
            const points = parseInt(parts[2]);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            if (name && code && !isNaN(points) && !subjects.some(s => s.code === code)) {
                subjects.push({ name, code, points });
                added++;
            }
        });

        localStorage.setItem("subjects", JSON.stringify(subjects));
        alert(`‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${added} ‡∏ß‡∏¥‡∏ä‡∏≤`);
        renderSubjects(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        document.getElementById("subjectCSV").value = "";
    };
    reader.readAsText(file, 'UTF-8');
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô CSV
function downloadAllSubjectReport() {
    const subjects = JSON.parse(localStorage.getItem("subjects") || "[]");
    if (subjects.length === 0) {
        alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å");
        return;
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ CSV (‡πÉ‡∏™‡πà BOM ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Excel ‡∏≠‡πà‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏≠‡∏≠‡∏Å)
    let csv = "\uFEFF‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤,‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤,‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ\n";
    subjects.forEach(s => {
        csv += `"${s.name}","${s.code}","${s.points}"\n`;
    });

    downloadCSV(csv, "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î.csv");
}

/* üÜï Utility Function: ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV */
function downloadCSV(csvContent, fileName) {
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", fileName);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
/* =======================
   ‡∏™‡∏•‡∏±‡∏ö Tab
======================= */
const btnActivity = document.getElementById('modeActivity');
const btnSubject  = document.getElementById('modeSubject');
const btnStudent  = document.getElementById('modeStudent');

const activityPanel = document.getElementById('adminPanel');
const subjectPanel  = document.getElementById('subjectPanel');
const studentPanel  = document.getElementById('studentPanel');

btnActivity.addEventListener('click', () => {
  activityPanel.style.display = 'block';
  subjectPanel.style.display  = 'none';
  studentPanel.style.display  = 'none';

  btnActivity.classList.add("active");
  btnSubject.classList.remove("active");
  btnStudent.classList.remove("active");
  loadEvents();
});

btnSubject.addEventListener('click', () => {
  activityPanel.style.display = 'none';
  subjectPanel.style.display  = 'block';
  studentPanel.style.display  = 'none';

  btnActivity.classList.remove("active");
  btnSubject.classList.add("active");
  btnStudent.classList.remove("active");
  renderSubjects();
});

btnStudent.addEventListener('click', () => {
  activityPanel.style.display = 'none';
  subjectPanel.style.display  = 'none';
  studentPanel.style.display  = 'block';

  btnActivity.classList.remove("active");
  btnSubject.classList.remove("active");
  btnStudent.classList.add("active");

  renderStudents();
});

/* =======================
   Admin Login
======================= */
function adminLogin() {
  const u = document.getElementById("adminUser").value.trim();
  const p = document.getElementById("adminPass").value.trim();

  if (u === "admin" && p === "8888") {
    localStorage.setItem("adminLogin", "true");
    document.getElementById("adminLogin").style.display="none";
    activityPanel.style.display="block";
    btnActivity.classList.add("active");
    loadEvents();
  } else {
    alert("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‚ùå");
  }
}

function adminLogout() {
  localStorage.removeItem("adminLogin");
  location.href="login.html";
}

if(localStorage.getItem("adminLogin")==="true"){
  document.getElementById("adminLogin").style.display="none";
  activityPanel.style.display="block";
  btnActivity.classList.add("active");
  loadEvents();
}

/* =======================
   ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (Events)
======================= */
function getEvents(){ 
    return JSON.parse(localStorage.getItem("events") || "{}"); 
} 

function saveEvents(events){ 
    localStorage.setItem("events", JSON.stringify(events)); 
} 

function getRegistrations(){
    return JSON.parse(localStorage.getItem("registrations") || "{}");
}

/* ==========================================
   ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (Events) - ‡πÄ‡∏û‡∏¥‡πà‡∏°, ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
   ========================================== */

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡πÄ‡∏ß‡∏•‡∏≤)
function addEvent() {
  const title = document.getElementById("eventTitle").value.trim();
  const dateInput = document.getElementById("eventDate");
  const date = $(dateInput).data('realDate'); // ‡∏Ñ‡πà‡∏≤ ‡∏Ñ.‡∏®. ‡∏à‡∏£‡∏¥‡∏á
  const start = document.getElementById("eventStart").value; 
  const end   = document.getElementById("eventEnd").value;   
  const mode  = document.getElementById("eventMode").value;

  if(!title || !date || !start || !end){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }

  const events = getEvents();
  if(!events[date]) events[date] = [];

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ (Basic check)
  const isConflict = events[date].some(event => {
    return (start < event.end && end > event.start);
  });

  if (isConflict) {
    alert("‚ùå ‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ã‡πâ‡∏≠‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß!");
    return;
  }

  events[date].push({ title, start, end, mode });
  saveEvents(events);

  alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úî");

  // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
  document.getElementById("eventTitle").value="";
  document.getElementById("eventDate").value="";
  document.getElementById("eventStart").value="";
  document.getElementById("eventEnd").value="";
  document.getElementById("eventMode").value="register";

  if(typeof renderEvents === "function") renderEvents(); 
  else if(typeof loadEvents === "function") loadEvents();
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å CSV
function importEventsCSV() {
    const fileInput = document.getElementById("eventCSV");
    const file = fileInput.files[0];
    if (!file) {
        alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        return;
    }

    const reader = new FileReader();
    reader.onload = e => {
        const lines = e.target.result.split(/\r?\n/);
        let events = getEvents();
        let addedCount = 0;

        lines.forEach((line, i) => {
            if (i === 0 || !line.trim()) return; // ‡∏Ç‡πâ‡∏≤‡∏° Header

            // ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤
            const parts = line.split(",").map(x => x.trim().replace(/^"|"$/g, ''));
            if (parts.length < 5) return;

            const date  = parts[0]; // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö 2025-02-25
            const title = parts[1];
            const start = parts[2];
            const end   = parts[3];
            const mode  = parts[4]; // 'register' ‡∏´‡∏£‡∏∑‡∏≠ 'notify'

            if (date && title && start && end) {
                if (!events[date]) events[date] = [];
                
                // (‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤
                const isDup = events[date].some(ev => ev.title === title && ev.start === start);
                if(!isDup) {
                    events[date].push({ title, start, end, mode });
                    addedCount++;
                }
            }
        });

        saveEvents(events);
        alert(`‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${addedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
        if(typeof renderEvents === "function") renderEvents();
        fileInput.value = ""; 
    };
    reader.readAsText(file, 'UTF-8');
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (CSV)
function downloadAllEventsReport() {
    const events = getEvents();
    if (Object.keys(events).length === 0) {
        alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î");
        return;
    }

    // ‡πÉ‡∏™‡πà \uFEFF ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Excel ‡∏≠‡πà‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏≠‡∏≠‡∏Å
    let csvContent = "\uFEFF‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°,‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°,‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó\n";
    
    // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    Object.keys(events).sort().forEach(date => {
        events[date].forEach(ev => {
            const modeName = ev.mode === 'register' ? '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô' : '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå';
            csvContent += `"${date}","${ev.title}","${ev.start}","${ev.end}","${modeName}"\n`;
        });
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°.csv";
    link.click();
}

function loadEvents(){
  const list = document.getElementById("eventList");
  const events = getEvents();
  list.innerHTML="";

  const dates = Object.keys(events).sort();
  if(dates.length === 0){
    list.innerHTML="<li class='list-group-item text-center text-muted'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</li>";
    return;
  }

  dates.forEach(date => {
    const dateTitle = document.createElement("li");
    dateTitle.className = "list-group-item bg-light fw-bold mt-2";
    
    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏° ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd/mm/yyyy (‡∏õ‡∏µ ‡∏û.‡∏®.)
    const dateObj = new Date(date);
    const thaiDate = dateObj.toLocaleDateString('th-TH', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
    
    dateTitle.textContent = "üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà " + thaiDate;
    list.appendChild(dateTitle);

    // ... ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° ...
    events[date].sort((a,b) => a.start.localeCompare(b.start)).forEach((event, i) => {
      // (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
      const li = document.createElement("li");
      li.className="list-group-item";
      li.innerHTML = `
        <div>
          <strong class="text-primary">${event.title}</strong>
          <span class="badge bg-secondary">${event.mode === 'register' ? '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô' : '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå'}</span>
          <br>
          <small class="text-muted">${event.start} - ${event.end}</small>
        </div>
        <div class="d-flex gap-2">
          ${event.mode === 'register' ? `<button class="btn btn-sm btn-outline-primary" onclick="showEventDetail('${date}', ${i})">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>` : ''}
          <button class="btn btn-sm btn-outline-danger" onclick="deleteEvent('${date}', ${i})">‡∏•‡∏ö</button>
        </div>
      `;
      list.appendChild(li);
    });
  });
}

function deleteEvent(date, index){
  if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){
    const events = getEvents();
    if(events[date]){
      events[date].splice(index, 1);
      if(events[date].length === 0){
        delete events[date];
      }
      saveEvents(events);
      
      // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢
      const registrations = JSON.parse(localStorage.getItem("registrations") || "{}");
      if(registrations[date]){
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö
        registrations[date] = registrations[date].filter(r => !r.endsWith(`_${index}`));
        localStorage.setItem("registrations", JSON.stringify(registrations));
      }
      
      loadEvents();
    }
  }
}

function showEventDetail(date, index) {
  const events = getEvents();
  const regs = getRegistrations();
  const event = events[date][index];
  const list = regs[date] || [];

  const filtered = list.filter(r => {
    if (r && typeof r === 'object') return r.idx == index;
    return typeof r === 'string' && r.endsWith(`_${index}`);
  });

  document.getElementById("detailTitle").innerText = event.title;
  document.getElementById("detailDate").innerText = date;
  document.getElementById("detailCount").innerText = filtered.length;

  const students = JSON.parse(localStorage.getItem("students") || "[]");
  const gallery = document.getElementById("imageGallery");
  gallery.innerHTML = ""; 

  if (filtered.length === 0) {
    gallery.innerHTML = `<div class="col-12 text-center text-muted p-5">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ</div>`;
  }

  filtered.forEach((r, i) => {
    const isObj = (typeof r === 'object' && r !== null);
    const id = isObj ? r.username : r.split("_")[0];
    const timestamp = isObj ? new Date(r.timestamp).toLocaleTimeString('th-TH') : '-';
    const imageData = isObj ? r.image : null;

    const stu = students.find(s => s.id === id);
    const name = stu ? stu.name : "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠";

    const col = document.createElement("div");
    col.className = "col-6 col-md-4 col-lg-3"; 
    col.innerHTML = `
      <div class="card h-100 shadow-sm border-0 position-relative">
        <button class="btn btn-danger btn-sm position-absolute" 
                style="top: 5px; right: 5px; z-index: 10; border-radius: 50%; width: 28px; height: 28px; padding: 0; line-height: 1;"
                onclick="deleteRegistration('${date}', ${index}, '${id}')">
          &times;
        </button>

        <div style="height: 140px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 8px 8px 0 0;">
          ${imageData 
            ? `<img src="${imageData}" class="card-img-top" style="object-fit: cover; height: 100%; width: 100%; cursor: pointer;" onclick="viewEvidence('${imageData}', '${id}')">` 
            : `<div class="text-muted small">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>`
          }
        </div>
        <div class="card-body p-2 text-center">
          <p class="mb-0 fw-bold text-truncate" style="font-size: 0.85rem;">${name}</p>
          <p class="mb-0 text-muted" style="font-size: 0.75rem;">ID: ${id}</p>
          <p class="mb-0 text-primary" style="font-size: 0.7rem;">üïí ${timestamp}</p>
        </div>
      </div>
    `;
    gallery.appendChild(col);
  });

  // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
  const downloadBtn = document.getElementById("downloadEventRegBtn");
  if (downloadBtn) {
    downloadBtn.onclick = () => {
      const header = "\uFEFF‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô,‡πÅ‡∏ú‡∏ô‡∏Å,‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô\n";
      let csvContent = header;
      filtered.forEach(r => {
        const isObj = (typeof r === 'object');
        const id = isObj ? r.username : r.split("_")[0];
        const time = isObj ? new Date(r.timestamp).toLocaleString('th-TH') : '-';
        const stu = students.find(s => s.id === id);
        const n = stu ? stu.name : id;
        const g = stu ? stu.grade || '-' : '-';
        const d = stu ? stu.dept || '-' : '-';
        csvContent += `"${n}","${id}","${g}","${d}","${time}"\n`;
      });
      downloadCSV(csvContent, `‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô_${event.title}_${date}.csv`);
    };
  }

  new bootstrap.Modal(document.getElementById("detailModal")).show();
}
/**
 * üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡∏Å‡∏±‡∏ô‡πÇ‡∏Å‡∏á)
 * - ‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
 * - ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏´‡∏°‡πà
 * - ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
 */
function deleteRegistration(date, eventIdx, studentId) {
  if (!confirm(
`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${studentId}

‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô:
1) ‡πÅ‡∏ï‡πâ‡∏°‡∏à‡∏≤‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å
2) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÅ‡∏•‡∏Å
3) ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`
  )) return;

  /* -------------------------
     1. ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
  --------------------------*/
  const regs = getRegistrations();

  Object.keys(regs).forEach(d => {
    regs[d] = regs[d].filter(r => {
      if (typeof r === "object" && r !== null) {
        return !(r.username === studentId && r.idx == eventIdx);
      }
      return r !== `${studentId}_${eventIdx}`;
    });
  });

  saveRegistrations(regs);

  /* -------------------------
     2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
     (1 ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° = 0.5 ‡πÅ‡∏ï‡πâ‡∏°)
  --------------------------*/
  let joinCount = 0;
  Object.values(regs).forEach(list => {
    list.forEach(r => {
      const rid = typeof r === "object" ? r.username : r.split("_")[0];
      if (rid === studentId) joinCount++;
    });
  });

  let remainingPoints = joinCount * 0.5;

  /* -------------------------
     3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤
  --------------------------*/
  const redeemLogs = JSON.parse(localStorage.getItem("redeemLogs") || "[]");
  const history = JSON.parse(localStorage.getItem("history_" + studentId) || "[]");

  const studentRedeems = redeemLogs.filter(r => r.studentID === studentId);
  const otherRedeems = redeemLogs.filter(r => r.studentID !== studentId);

  let validRedeems = [];
  let validHistory = [];

  studentRedeems.forEach(log => {
    if (remainingPoints >= log.cost) {
      remainingPoints -= log.cost;
      validRedeems.push(log);

      const h = history.find(
        x => x.code === log.subjectCode && x.date === log.date
      );
      if (h) validHistory.push(h);
    } else {
      console.warn(
        `‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ ${log.subjectName} ‡∏Ç‡∏≠‡∏á ${studentId} (‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠)`
      );
    }
  });

  /* -------------------------
     4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö
  --------------------------*/
  localStorage.setItem(
    "redeemLogs",
    JSON.stringify([...otherRedeems, ...validRedeems])
  );
  localStorage.setItem(
    "history_" + studentId,
    JSON.stringify(validHistory)
  );
  localStorage.setItem(
    "points_" + studentId,
    remainingPoints.toFixed(1)
  );

  /* -------------------------
     5. ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏• + ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤
  --------------------------*/
  alert(
`‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ
‡πÅ‡∏ï‡πâ‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${remainingPoints.toFixed(1)}
‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß`
  );

  const modal = bootstrap.Modal.getInstance(
    document.getElementById("detailModal")
  );
  if (modal) modal.hide();

  renderAllEvents();
}

/* =======================
   ‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°
======================= */
function getSubjects(){
    return JSON.parse(localStorage.getItem("subjects") || "[]");
}

function saveSubjects(subjects){
    localStorage.setItem("subjects", JSON.stringify(subjects));
}

function addSubject(){
  const name = document.getElementById("subjectName").value.trim();
  const code = document.getElementById("subjectCode").value.trim();
  const points = parseInt(document.getElementById("subjectPoints").value);

  if(!name || !code || isNaN(points)){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }

  let sub = getSubjects();
  if(sub.some(s => s.code === code)){
    alert("‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
    return;
  }
  
  sub.push({ name, code, points });
  saveSubjects(sub);

  document.getElementById("subjectName").value="";
  document.getElementById("subjectCode").value="";
  document.getElementById("subjectPoints").value="";

  renderSubjects();
}

function renderSubjects(){
  const list = document.getElementById("subjectList");
  const subjects = getSubjects();

  list.innerHTML="";

  if(subjects.length===0){
    list.innerHTML="<li class='list-group-item text-center text-muted'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤</li>";
    return;
  }

  subjects.forEach((s,i)=>{
    const li = document.createElement("li");
    li.className="list-group-item d-flex justify-content-between align-items-center";

    li.innerHTML = `
      <div>
        <strong class="text-primary">${s.name} (${s.code})</strong>
        <br>
        <small class="text-muted">‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏° ${s.points} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</small>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-primary" onclick="showSubjectDetail('${s.code}')">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteSubject(${i})">‡∏•‡∏ö</button>
      </div>
    `;

    list.appendChild(li);
  });
}

function deleteSubject(i){
  if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){
    let subjects = getSubjects();
    subjects.splice(i,1);
    saveSubjects(subjects);
    renderSubjects();
  }
}

/* ‚≠ê Modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ß‡∏¥‡∏ä‡∏≤ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV) */
function showSubjectDetail(code){
  const subjects = getSubjects();
  const logs = JSON.parse(localStorage.getItem("redeemLogs") || "[]");
  const students = JSON.parse(localStorage.getItem("students") || "[]");

  const sub = subjects.find(s => s.code === code);
  const filtered = logs.filter(l => l.subjectCode === code);

  document.getElementById("subCode").innerText = sub.code;
  document.getElementById("subName").innerText = sub.name;
  document.getElementById("subCount").innerText = filtered.length;

  const ul = document.getElementById("subList");
  ul.innerHTML="";

  filtered.forEach(item=>{
    const stu = students.find(s => s.id === item.studentID);
    const li = document.createElement("li");
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà (Grade, Dept) ‡∏î‡πâ‡∏ß‡∏¢
    const grade = stu ? stu.grade || '-' : '-';
    const dept = stu ? stu.dept || '-' : '-';

    li.textContent = stu
      ? `${stu.name} (${stu.id}) | ‡∏ä‡∏±‡πâ‡∏ô: ${grade}, ‡πÅ‡∏ú‡∏ô‡∏Å: ${dept}`
      : item.studentID;

    ul.appendChild(li);
  });

  new bootstrap.Modal(document.getElementById("subjectDetailModal")).show();

  // üÜï ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤
  document.getElementById("downloadSubjectRedeemBtn").onclick = () => {
      // NEW: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞ ‡πÅ‡∏ú‡∏ô‡∏Å
      const header = "‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô,‡πÅ‡∏ú‡∏ô‡∏Å,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å\n";
      let csvContent = header;

      filtered.forEach(item => {
          const stu = students.find(s => s.id === item.studentID);
          const name = stu ? stu.name : item.studentID;
          const grade = stu ? stu.grade || '-' : '-';
          const dept = stu ? stu.dept || '-' : '-';
          
          csvContent += `"${name}",${item.studentID},"${grade}","${dept}",${item.date}\n`;
      });
      
      downloadCSV(csvContent, `‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°_${sub.code}_${sub.name}.csv`);
  };
}

renderSubjects();

/* =======================
   ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
======================= */
function addStudent() {
  const name = document.getElementById("stdName").value.trim();
  const id = document.getElementById("stdId").value.trim();
  const grade = document.getElementById("stdGrade").value; 
  const dept = document.getElementById("stdDept").value;   
  const dobRaw = document.getElementById("stdDob").value.trim();

  // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö / ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô 10082547
  const dob = dobRaw.replace(/\//g, '');

  if(!name || !id || !grade || !dept || !dob) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å/‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô");
    return;
  }

  let students = JSON.parse(localStorage.getItem("students") || "[]");
  if(students.some(s => s.id === id)) {
    alert("‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
    return;
  }

  students.push({ name, id, grade, dept, dob });
  localStorage.setItem("students", JSON.stringify(students));

  // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°
  document.getElementById("stdName").value = "";
  document.getElementById("stdId").value = "";
  document.getElementById("stdGrade").selectedIndex = 0; 
  document.getElementById("stdDept").selectedIndex = 0;  
  document.getElementById("stdDob").value = "";

  renderStudents();
  alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
}

function renderStudents(){
  const students = JSON.parse(localStorage.getItem("students") || "[]");
  const list = document.getElementById("studentList");

  list.innerHTML="";

  if(students.length===0){
    list.innerHTML="<li class='list-group-item text-center text-muted'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</li>";
    return;
  }

  students.forEach((s,i)=>{
    const li = document.createElement("li");
    li.className="list-group-item d-flex justify-content-between align-items-center";

    // NEW: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á grade ‡πÅ‡∏•‡∏∞ dept
    li.innerHTML = `
      <div>
        <strong class="text-primary">${s.name} (${s.id})</strong>
        <br>
        <small class="text-muted">‡∏ä‡∏±‡πâ‡∏ô: ${s.grade || '-'}, ‡πÅ‡∏ú‡∏ô‡∏Å: ${s.dept || '-'} - ‡πÄ‡∏Å‡∏¥‡∏î: ${(s.dob || '').replace(/\//g, '')}</small>
      </div>
      <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-primary" onclick="showStudentDetail('${s.id}')">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent(${i})">‡∏•‡∏ö</button>
      </div>
    `;

    list.appendChild(li);
  });
}

function deleteStudent(i){
  if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){
    let students = JSON.parse(localStorage.getItem("students") || "[]");
    students.splice(i,1);
    localStorage.setItem("students", JSON.stringify(students));
    renderStudents();
  }
}

/* üÜï Function: ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
/* üÜï Function: ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
function downloadAllStudentsReport() { // ‡πÄ‡∏û‡∏¥‡πà‡∏° s ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö HTML
    const students = JSON.parse(localStorage.getItem("students") || "[]");
    const redeemLogs = JSON.parse(localStorage.getItem("redeemLogs") || "[]");
    const events = getEvents();
    const registrations = getRegistrations();
    const subjects = getSubjects();
    
    if (students.length === 0) {
        alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î");
        return;
    }

    // Header for the CSV (‡πÉ‡∏™‡πà \uFEFF ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Excel ‡∏≠‡πà‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏≠‡∏≠‡∏Å)
    let csvContent = "\uFEFF‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô,‡πÅ‡∏ú‡∏ô‡∏Å,‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏Ñ‡∏£‡∏±‡πâ‡∏á),‡∏Ç‡∏≤‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏Ñ‡∏£‡∏±‡πâ‡∏á),‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏° (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô),‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å\n";

    students.forEach(student => {
        const studentId = student.id;
        
        // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î
        let attendedCount = 0;
        let missedCount = 0;
        
        Object.keys(events).forEach(date => {
            events[date].forEach((event, index) => {
                if (event.mode === 'register') {
                    const dayRegs = registrations[date] || [];
                    const isRegistered = dayRegs.some(r => {
                        if (r && typeof r === 'object') {
                            return r.username === studentId && r.idx == index;
                        }
                        return r === `${studentId}_${index}`;
                    });
                    
                    if (isRegistered) {
                        attendedCount++;
                    } else {
                        missedCount++; 
                    }
                }
            });
        });

        // 2. ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°
        const studentPoints = parseFloat(localStorage.getItem(`points_${studentId}`) || "0").toFixed(1);

        // 3. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å
        const studentRedeems = redeemLogs.filter(log => log.studentID === studentId);
        const redeemSummary = studentRedeems.reduce((acc, log) => {
            const sub = subjects.find(s => s.code === log.subjectCode);
            const subjectName = sub ? sub.name : `(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤: ${log.subjectCode})`;
            if (acc[subjectName]) { acc[subjectName]++; } else { acc[subjectName] = 1; }
            return acc;
        }, {});
        
        const redeemedList = Object.keys(redeemSummary).map(name => 
            `${name} (${redeemSummary[name]} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`
        ).join(' | ');

        // ‡∏£‡∏ß‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        csvContent += `"${student.name}","${student.id}","${student.grade || '-'}","${student.dept || '-'}",${attendedCount},${missedCount},${studentPoints},${studentRedeems.length},"${redeemedList}"\n`;
    });

    downloadCSV(csvContent, `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.csv`);
}

/* ‚≠ê Function: ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô */
function showStudentDetail(studentId){
    const students = JSON.parse(localStorage.getItem("students") || "[]");
    const redeemLogs = JSON.parse(localStorage.getItem("redeemLogs") || "[]");
    const events = getEvents();
    const registrations = getRegistrations();

    const student = students.find(s => s.id === studentId);
    if(!student) return;

    // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î
    let attendedCount = 0;
    let missedCount = 0;
    const now = new Date(); // ‡∏î‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö

    Object.keys(events).forEach(date => {
        // ‡πÅ‡∏¢‡∏Å‡∏™‡πà‡∏ß‡∏ô ‡∏õ‡∏µ-‡πÄ‡∏î‡∏∑‡∏≠‡∏ô-‡∏ß‡∏±‡∏ô ‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
        const [y, m, d] = date.split("-").map(Number);
        
        events[date].forEach((event, index) => {
            if (event.mode === 'register') {
                // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á Object ‡πÅ‡∏•‡∏∞ String
                const dayRegs = registrations[date] || [];
                const isRegistered = dayRegs.some(r => {
                    if (r && typeof r === 'object') {
                        return r.username === studentId && r.idx == index;
                    }
                    return r === `${studentId}_${index}`;
                });
                
                if (isRegistered) {
                    attendedCount++;
                } else {
                    // üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤: ‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡∏ß‡πà‡∏≤ "‡∏Ç‡∏≤‡∏î" ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏û‡πâ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô 23:59)
                    const [endHour, endMin] = (event.end || "23:59").split(":").map(Number);
                    const eventEndTime = new Date(y, m - 1, d, endHour, endMin);

                    if (now > eventEndTime) {
                        missedCount++;
                    }
                }
            }
        });
    });

    // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏° (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
    const totalEarned = attendedCount * 0.5;
    let redeemedPoints = 0;
    const studentRedeems = redeemLogs.filter(log => log.studentID === studentId);
    studentRedeems.forEach(log => {
        redeemedPoints += parseFloat(log.cost || 0);
    });
    
    const finalPoints = (totalEarned - redeemedPoints) < 0 ? 0 : (totalEarned - redeemedPoints);

    // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å
    const redeemListUl = document.getElementById("stuRedeemList");
    redeemListUl.innerHTML = "";

    if (studentRedeems.length === 0) {
        redeemListUl.innerHTML = "<li class='list-group-item text-center text-muted'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</li>";
    } else {
        [...studentRedeems].reverse().forEach(log => {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.innerHTML = `
                <span>
                    <strong>${log.subjectName}</strong> (${log.subjectCode})<br>
                    <small class="text-muted">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å: ${log.date}</small>
                </span>
                <span class="badge bg-danger rounded-pill">-${log.cost} ‡πÅ‡∏ï‡πâ‡∏°</span>
            `;
            redeemListUl.appendChild(li);
        });
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô Modal
    const nameEl = document.getElementById("stuDetailName");
    const infoText = `‡∏ä‡∏±‡πâ‡∏ô: ${student.grade || '-'} | ‡πÅ‡∏ú‡∏ô‡∏Å: ${student.dept || '-'}`;
    nameEl.innerHTML = `<strong>${student.name}</strong> (${student.id})<br><small class="text-muted">${infoText}</small>`;

    document.getElementById("stuAttendedCount").innerText = attendedCount;
    document.getElementById("stuMissedCount").innerText = missedCount; // ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÅ‡∏•‡πâ‡∏ß
    document.getElementById("stuPointCount").innerText = finalPoints.toFixed(1);
    document.getElementById("stuRedeemTotal").innerText = studentRedeems.length;

    new bootstrap.Modal(document.getElementById("studentDetailModal")).show();
}

/* =======================
   Import CSV
======================= */
function importStudentsCSV(){
  const file = document.getElementById("studentCSV").files[0];
  if(!file) { alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏Å‡πà‡∏≠‡∏ô"); return; }

  const reader = new FileReader();
  reader.onload = e => {
    const lines = e.target.result.split(/\r?\n/);
    let students = JSON.parse(localStorage.getItem("students") || "[]");
    let added = 0;

    lines.forEach((line, i) => {
      if(i === 0 || !line.trim()) return; // ‡∏Ç‡πâ‡∏≤‡∏° Header ‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á
      
      // ‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏≠‡∏≠‡∏Å
      const parts = line.split(",").map(x => x.trim().replace(/^"|"$/g, ''));
      
      if (parts.length >= 5) {
        const [name, id, grade, dept, dob] = parts;
        if(!students.some(s => s.id === id)) {
          students.push({ name, id, grade, dept, dob });
          added++;
        }
      }
    });

    localStorage.setItem("students", JSON.stringify(students));
    renderStudents();
    alert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${added} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
  };
  reader.readAsText(file, 'UTF-8'); // ‡πÉ‡∏™‡πà UTF-8 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
}

renderStudents();

</script>


<!-- jQuery UI Datepicker (Thai BE) -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<script>
$(function () {
    // 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    $.datepicker.regional['th'] = {
        closeText: '‡∏õ‡∏¥‡∏î', prevText: '‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤', nextText: '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ',
        monthNames: ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'],
        dayNamesMin: ['‡∏≠‡∏≤','‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™'],
        dateFormat: 'dd/mm/yy',
        changeMonth: true,
        changeYear: true,
        yearRange: 'c-60:c+10'
    };
    $.datepicker.setDefaults($.datepicker.regional['th']);

    // 2. ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" (‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î) -> ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏µ ‡∏û.‡∏®.
    $(document).on('focus', "#stdDob", function(){
        $(this).datepicker({
            isBE: true, // ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ ‡∏û.‡∏®.
            beforeShow: function(input, inst) {
                // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏•‡∏Ç‡∏õ‡∏µ‡πÉ‡∏ô Dropdown ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®. ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                setTimeout(function() {
                    $('.ui-datepicker-year option').each(function() {
                        var year = parseInt($(this).val());
                        if (year < 2400) $(this).text(year + 543);
                    });
                }, 1);
            },
            onChangeMonthYear: function(year, month, inst) {
                setTimeout(function() {
                    $('.ui-datepicker-year option').each(function() {
                        var y = parseInt($(this).val());
                        if (y < 2400) $(this).text(y + 543);
                    });
                }, 1);
            }
        });
    });
    
    // 3. ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°" -> ‡πÉ‡∏ä‡πâ ‡∏Ñ.‡∏®. ‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
    $(document).on('focus', "#eventDate", function () {
    $(this).datepicker({
        dateFormat: 'dd/mm/yy', 
        isBE: false,             // üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô false ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á Input ‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®. (2026)
        changeMonth: true,
        changeYear: true,
        onSelect: function (dateText) {
            const parts = dateText.split('/');
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ database ‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD (‡∏Ñ.‡∏®.)
            const formatted = `${parts[2]}-${parts[1]}-${parts[0]}`; 
            $(this).data('realDate', formatted);
        }
    });
});
});
(function($){
    if (!$.datepicker) return;

    const _oldGenerate = $.datepicker._generateMonthYearHeader;
    $.datepicker._generateMonthYearHeader = function(inst, drawMonth, drawYear,
        minDate, maxDate, secondary, monthNames, monthNamesShort) {

        let html = _oldGenerate.call(this, inst, drawMonth, drawYear,
            minDate, maxDate, secondary, monthNames, monthNamesShort);

        // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ ---
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô id "eventDate" (‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°) ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° (‡∏Ñ.‡∏®.) ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏ß‡∏Å 543
        if (inst.id === 'eventDate') {
            return html;
        }

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏•‡∏Ç‡∏õ‡∏µ‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®. ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
        return html.replace(/\b(19|20)\d{2}\b/g, function(y){
            return parseInt(y, 10) + 543;
        });
        // ------------------
    };
})(jQuery);
</script>





</body>
</html>
