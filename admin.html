<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (Admin)</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
/* ===================================
   CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢ (Admin)
   ‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏£‡∏°‡∏ó‡πà‡∏≤ (#003366) ‡πÅ‡∏•‡∏∞‡∏™‡∏µ‡∏ó‡∏≠‡∏á (#FFC107)
   =================================== */
:root {
    --college-primary: #003366;
    --college-accent: #FFC107;
}

body { 
    background: #F0F4F8; 
    font-family: "Kanit", sans-serif; 
    padding: 0; 
    margin-top: 70px;
}

/* Navbar */
.bg-college-primary { background-color: var(--college-primary) !important; }
.Font { 
    font-size: 28px; 
    color: white !important; 
    font-weight: 700; 
    display: flex; 
    align-items: center; 
}
.logo-school { 
    width: 40px; 
    height:auto; 
    margin-right: 10px; 
    margin-left: 0; 
    filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
}

/* Layout and Containers */
.main-layout { 
    display: flex; 
    margin: 20px auto; 
    padding: 20px; 
    gap: 20px; 
    max-width: 1200px;
    width: 95%; 
    box-sizing: border-box; 
    align-items: flex-start;
}

h3, h5 { 
    text-align: center; 
    font-weight: 700; 
    color: var(--college-primary); 
    margin-bottom: 20px; 
}

/* Sidebar (Menu) */
.sidebar { 
    width: 250px; 
    background: #fff; 
    padding: 20px; 
    border-radius: 8px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
    display:flex; 
    flex-direction:column; 
    gap:10px; 
}
.sidebar button { 
    border: none; 
    border-radius: 8px; 
    padding: 12px; 
    font-weight: 600; 
    background: #EAF0F6;
    color: var(--college-primary); 
    transition: 0.3s; 
    text-align: left;
}
.sidebar button:hover { 
    background: #DCE3EA; 
}
.sidebar button.active { 
    background: var(--college-primary); 
    color: var(--college-accent); 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.sidebar .logout-btn { 
    background: #dc3545; 
    color: white; 
    margin-top: 20px;
}

/* Main Content Area & Forms */
.content { 
    flex: 1; 
    background: #fff; 
    padding: 30px; 
    border-radius: 8px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
    min-height: 400px; 
    display: block; 
}
#adminLogin {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
}

.form-control, .form-select { border-radius: 6px; }
.btn-primary, .btn-success { background-color: var(--college-primary); border-color: var(--college-primary); font-weight: 600;}
.btn-primary:hover, .btn-success:hover { background-color: #002B5C; border-color: #002B5C; }
.btn-info { 
    background-color: var(--college-accent) !important; 
    border-color: var(--college-accent) !important; 
    color: var(--college-primary) !important; 
    font-weight: 600;
}
.btn-info:hover { background-color: #E6B000 !important; border-color: #E6B000 !important; }

.list-group-item { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    border-radius: 8px !important;
    margin-bottom: 8px;
    background-color: #f7f9fb;
    border-left: 5px solid var(--college-primary);
}

/* Modals */
.modal-content { border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.modal-header { 
    background-color: var(--college-primary); 
    color: white; 
    border-bottom: none; 
    border-top-left-radius: 12px; 
    border-top-right-radius: 12px; 
}
.modal-title 
{ font-weight: 700; 
  filter: invert(1) grayscale(100%) brightness(200%);
}

/* Stats Box in Student Detail Modal */
.stat-box { 
    background: #fff; 
    padding: 15px 10px; 
    border-radius: 8px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.stat-box strong { 
    display: block; 
    font-size: 1.8rem; 
    color: var(--college-primary); 
    font-weight: 700;
}
.stat-box.bg-success-subtle strong { color: #198754; }
.stat-box.bg-danger-subtle strong { color: #dc3545; }
.stat-box.bg-info-subtle strong { color: var(--college-accent); }


@media (max-width:992px) {
  .main-layout { flex-direction: column; }
  .sidebar { width: 100%; margin-bottom: 20px; }
}
@media (max-width:600px) {
  .container { width:100%; border-radius:0; box-shadow:none; }
}
</style>
</head>
<body>

<nav class="navbar navbar-dark bg-college-primary fixed-top">
  <div class="container-fluid">
    <div class="Font">
      <img src="‡∏ï‡∏£‡∏≤.png" class="logo-school">
      ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (Admin)
    </div>
    <div class="d-flex align-items-center">
      <span id="userText" class="text-white me-2"></span>
      <button class="btn btn-danger btn-sm" onclick="adminLogout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </div>
</nav>

<div class="main-layout">

  <div class="sidebar">
    <div class="text-center"><h4><strong>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≤‡∏á‡πÜ</strong></h4></div>
    <button id="modeActivity" class="btn btn-primary">üìÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
    <button id="modeSubject" class="btn btn-secondary">üìï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°</button>
    <button id="modeStudent" class="btn btn-success">üë®‚Äçüéì ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
  </div>

  <div class="content" id="adminLogin">
    <h3>üõ† ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (Admin)</h3>
    <hr>
    <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
    <input id="adminUser" class="form-control mb-2" placeholder="admin">
    <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
    <input id="adminPass" type="password" class="form-control mb-2" placeholder="8888">
    <button class="btn btn-primary w-100 mt-3" onclick="adminLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <a href="index.html" class="btn btn-outline-secondary w-100 mt-2">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
  </div>

  <div class="content" id="adminPanel" style="display:none;">
    <h5 class="fw-bold mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà</h5>
    <input id="eventTitle" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">
    <input id="eventDate" type="date" class="form-control mb-2">
    <div class="d-flex gap-2 mb-2">
      <input id="eventStart" type="time" class="form-control">
      <input id="eventEnd" type="time" class="form-control">
    </div>
    <select id="eventMode" class="form-select mb-3">
      <option value="register">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</option>
      <option value="notify">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
    </select>
    <button class="btn btn-success w-100 mb-3" onclick="addEvent()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
    <hr>
    <h5 class="fw-bold mb-2">üìÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
    <ul id="eventList" class="list-group"></ul>
  </div>

  <div class="content" id="subjectPanel" style="display:none;">
    <h5 class="fw-bold mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡∏°‡πà</h5>
    <input id="subjectName" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤">
    <input id="subjectCode" class="form-control mb-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤">
    <input id="subjectPoints" type="number" class="form-control mb-2" placeholder="‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ">
    <button class="btn btn-success w-100 mb-3" onclick="addSubject()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤</button>

    <hr>
    <h5 class="fw-bold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
    <ul id="subjectList" class="list-group"></ul>
  </div>

  <div class="content" id="studentPanel" style="display:none;">
    <h5 class="fw-bold mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h5>
    <input id="studentName" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•">
    <input id="studentID" class="form-control mb-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
    <input id="studentGrade" class="form-control mb-2" placeholder="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô"> <input id="studentDept" class="form-control mb-2" placeholder="‡πÅ‡∏ú‡∏ô‡∏Å/‡∏™‡∏≤‡∏¢"> <input id="studentDOB" class="form-control mb-2" placeholder="‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î (dd/mm/yy)">
    <button class="btn btn-success w-100 mb-3" onclick="addStudent()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>

    <hr>
    <h5 class="fw-bold mb-3">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å CSV</h5>
    <div class="d-flex gap-2 mb-2"> <input type="file" id="studentCSV" accept=".csv" class="form-control">
      <button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#csvGuideModal">? ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö CSV</button>
    </div>
    <button class="btn btn-primary w-100 mb-3" onclick="importStudentsCSV()">Import CSV</button>

    <hr>
    <h5 class="fw-bold mb-3">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
    <button class="btn btn-info w-100 mb-3 text-white" onclick="downloadAllStudentReport()">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏° (CSV)</button>
    <hr>
    <h5 class="fw-bold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
    <ul id="studentList" class="list-group"></ul>
  </div>

</div>

<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</strong> <span id="detailTitle"></span></p>
        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> <span id="detailDate"></span></p>
        <p><strong>‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß:</strong> <span id="detailCount"></span> ‡∏Ñ‡∏ô</p>
        <hr>
        <h6>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</h6>
        <ul id="detailList"></ul>
      </div>

      <div class="modal-footer">
        <button class="btn btn-success me-auto" id="downloadEventRegBtn">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button> 
        <button class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="subjectDetailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <p><strong>‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤:</strong> <span id="subCode"></span></p>
        <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤:</strong> <span id="subName"></span></p>
        <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÅ‡∏•‡∏Å:</strong> <span id="subCount"></span> ‡∏Ñ‡∏ô</p>
        <hr>
        <h6>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏•‡∏Å</h6>
        <ul id="subList"></ul>
      </div>

      <div class="modal-footer">
        <button class="btn btn-success me-auto" id="downloadSubjectRedeemBtn">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="studentDetailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: <span id="stuDetailName"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="row text-center mb-3">
            <div class="col-4">
                <div class="stat-box bg-success-subtle">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°<br><strong><span id="stuAttendedCount">0</span></strong> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
            </div>
            <div class="col-4">
                <div class="stat-box bg-danger-subtle">‡∏Ç‡∏≤‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°<br><strong><span id="stuMissedCount">0</span></strong> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
            </div>
            <div class="col-4">
                <div class="stat-box bg-info-subtle">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°<br><strong><span id="stuPointCount">0</span></strong> ‡πÅ‡∏ï‡πâ‡∏°</div>
            </div>
        </div>

        <hr>
        <h6>üìï ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏•‡πâ‡∏ß (<span id="stuRedeemTotal">0</span> ‡∏ß‡∏¥‡∏ä‡∏≤)</h6>
        <ul id="stuRedeemList" class="list-group"></ul>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="csvGuideModal" tabindex="-1" aria-labelledby="csvGuideModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="csvGuideModalLabel">üìö ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î **5 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå** ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:</p>
        <ol class="list-group list-group-numbered">
          <li class="list-group-item">**‡∏ä‡∏∑‡πà‡∏≠** (‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</li>
          <li class="list-group-item">**‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô** (‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô)</li>
          <li class="list-group-item">**‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô** (‡πÄ‡∏ä‡πà‡∏ô ‡∏°.4/1, ‡∏õ‡∏ß‡∏ä.1)</li>
          <li class="list-group-item">**‡πÅ‡∏ú‡∏ô‡∏Å/‡∏™‡∏≤‡∏¢** (‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏¥‡∏ó‡∏¢‡πå-‡∏Ñ‡∏ì‡∏¥‡∏ï, ‡∏ä‡πà‡∏≤‡∏á‡∏¢‡∏ô‡∏ï‡πå)</li>
          <li class="list-group-item">**‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î** (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd/mm/yy ‡∏´‡∏£‡∏∑‡∏≠ dd/mm/yyyy)</li>
        </ol>
        <hr>
        <p class="text-danger small fw-bold">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ (Header Row):<br>
        `‡∏ä‡∏∑‡πà‡∏≠,‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô,‡πÅ‡∏ú‡∏ô‡∏Å,‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î`</p>
        <p class="text-success small fw-bold">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1:<br>
        `‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏Ç‡∏¢‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,12345,‡∏°.4/1,‡∏ß‡∏¥‡∏ó‡∏¢‡πå-‡∏Ñ‡∏ì‡∏¥‡∏ï,01/01/48`</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>
<script src="storage.js"></script>
<script src="calendar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<script>

/* üÜï Utility Function: ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV */
function downloadCSV(csv, filename) {
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° BOM (Byte Order Mark) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÉ‡∏ô Excel
    const BOM = "\uFEFF"; 
    const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    if (link.download !== undefined) { // Check for browser support
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

/* =======================
   ‡∏™‡∏•‡∏±‡∏ö Tab
======================= */
const btnActivity = document.getElementById('modeActivity');
const btnSubject  = document.getElementById('modeSubject');
const btnStudent  = document.getElementById('modeStudent');

const activityPanel = document.getElementById('adminPanel');
const subjectPanel  = document.getElementById('subjectPanel');
const studentPanel  = document.getElementById('studentPanel');

btnActivity.addEventListener('click', () => {
  activityPanel.style.display = 'block';
  subjectPanel.style.display  = 'none';
  studentPanel.style.display  = 'none';

  btnActivity.classList.add("active");
  btnSubject.classList.remove("active");
  btnStudent.classList.remove("active");
  loadEvents();
});

btnSubject.addEventListener('click', () => {
  activityPanel.style.display = 'none';
  subjectPanel.style.display  = 'block';
  studentPanel.style.display  = 'none';

  btnActivity.classList.remove("active");
  btnSubject.classList.add("active");
  btnStudent.classList.remove("active");
  renderSubjects();
});

btnStudent.addEventListener('click', () => {
  activityPanel.style.display = 'none';
  subjectPanel.style.display  = 'none';
  studentPanel.style.display  = 'block';

  btnActivity.classList.remove("active");
  btnSubject.classList.remove("active");
  btnStudent.classList.add("active");

  renderStudents();
});

/* =======================
   Admin Login
======================= */
function adminLogin() {
  const u = document.getElementById("adminUser").value.trim();
  const p = document.getElementById("adminPass").value.trim();

  if (u === "admin" && p === "8888") {
    localStorage.setItem("adminLogin", "true");
    document.getElementById("adminLogin").style.display="none";
    activityPanel.style.display="block";
    btnActivity.classList.add("active");
    loadEvents();
  } else {
    alert("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‚ùå");
  }
}

function adminLogout() {
  localStorage.removeItem("adminLogin");
  location.href="login.html";
}

if(localStorage.getItem("adminLogin")==="true"){
  document.getElementById("adminLogin").style.display="none";
  activityPanel.style.display="block";
  btnActivity.classList.add("active");
  loadEvents();
}

/* =======================
   ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (Events)
======================= */
function getEvents(){ 
    return JSON.parse(localStorage.getItem("events") || "{}"); 
} 

function saveEvents(events){ 
    localStorage.setItem("events", JSON.stringify(events)); 
} 

function getRegistrations(){
    return JSON.parse(localStorage.getItem("registrations") || "{}");
}

function addEvent(){
  const title = document.getElementById("eventTitle").value.trim();
  const date  = document.getElementById("eventDate").value;
  const start = document.getElementById("eventStart").value; // 24-hour format
  const end   = document.getElementById("eventEnd").value;   // 24-hour format
  const mode  = document.getElementById("eventMode").value;

  if(!title || !date || !start || !end){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }

  const events = getEvents();
  if(!events[date]) events[date] = [];

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ (Basic check)
  const isConflict = events[date].some(event => {
    return (start < event.end && end > event.start);
  });

  if (isConflict) {
    alert("‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ã‡πâ‡∏≠‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß!");
    return;
  }

  events[date].push({ title, start, end, mode });
  saveEvents(events);

  alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úî");

  // Clear form
  document.getElementById("eventTitle").value="";
  document.getElementById("eventDate").value="";
  document.getElementById("eventStart").value="";
  document.getElementById("eventEnd").value="";
  document.getElementById("eventMode").value="register";

  loadEvents();
}

function loadEvents(){
  const list = document.getElementById("eventList");
  const events = getEvents();
  list.innerHTML="";

  const dates = Object.keys(events).sort(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
  if(dates.length === 0){
    list.innerHTML="<li class='list-group-item text-center text-muted'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</li>";
    return;
  }

  dates.forEach(date => {
    const dateTitle = document.createElement("li");
    dateTitle.className = "list-group-item bg-light fw-bold mt-2";
    // ‡πÉ‡∏ä‡πâ toLocaleDateString ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢
    dateTitle.textContent = "üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà " + new Date(date).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
    list.appendChild(dateTitle);

    events[date].sort((a,b) => a.start.localeCompare(b.start)).forEach((event, i) => { // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°
      const li = document.createElement("li");
      li.className="list-group-item";
      
      li.innerHTML = `
        <div>
          <strong class="text-primary">${event.title}</strong>
          <span class="badge bg-secondary">${event.mode === 'register' ? '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô' : '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå'}</span>
          <br>
          <small class="text-muted">${event.start} - ${event.end}</small>
        </div>
        <div class="d-flex gap-2">
          ${event.mode === 'register' ? `<button class="btn btn-sm btn-outline-primary" onclick="showEventDetail('${date}', ${i})">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>` : ''}
          <button class="btn btn-sm btn-outline-danger" onclick="deleteEvent('${date}', ${i})">‡∏•‡∏ö</button>
        </div>
      `;
      list.appendChild(li);
    });
  });
}

function deleteEvent(date, index){
  if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){
    const events = getEvents();
    if(events[date]){
      events[date].splice(index, 1);
      if(events[date].length === 0){
        delete events[date];
      }
      saveEvents(events);
      
      // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢
      const registrations = JSON.parse(localStorage.getItem("registrations") || "{}");
      if(registrations[date]){
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö
        registrations[date] = registrations[date].filter(r => !r.endsWith(`_${index}`));
        localStorage.setItem("registrations", JSON.stringify(registrations));
      }
      
      loadEvents();
    }
  }
}

/* ‚≠ê ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV) */
function showEventDetail(date,index){
  const events = getEvents();
  const regs = getRegistrations();

  const event = events[date][index];
  const list = regs[date] || [];

  const filtered = list.filter(r => r.endsWith(`_${index}`));

  document.getElementById("detailTitle").innerText = event.title;
  document.getElementById("detailDate").innerText  = date;
  document.getElementById("detailCount").innerText = filtered.length;

  const students = JSON.parse(localStorage.getItem("students") || "[]");

  const ul = document.getElementById("detailList");
  ul.innerHTML="";

  filtered.forEach(r=>{
    const id = r.split("_")[0];
    const stu = students.find(s => s.id === id);

    const li = document.createElement("li");
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà (Grade, Dept) ‡∏î‡πâ‡∏ß‡∏¢
    const grade = stu ? stu.grade || '-' : '-';
    const dept = stu ? stu.dept || '-' : '-';
    li.textContent = stu ? `${stu.name} (${stu.id}) | ‡∏ä‡∏±‡πâ‡∏ô: ${grade}, ‡πÅ‡∏ú‡∏ô‡∏Å: ${dept}` : id;
    ul.appendChild(li);
  });

  new bootstrap.Modal(document.getElementById("detailModal")).show();

  // üÜï ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô
  document.getElementById("downloadEventRegBtn").onclick = () => {
      const eventName = event.title;
      // NEW: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞ ‡πÅ‡∏ú‡∏ô‡∏Å
      const header = "‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô,‡πÅ‡∏ú‡∏ô‡∏Å\n";
      let csvContent = header;

      filtered.forEach(r => {
          const id = r.split("_")[0];
          const stu = students.find(s => s.id === id);
          const name = stu ? stu.name : id;
          const grade = stu ? stu.grade || '-' : '-';
          const dept = stu ? stu.dept || '-' : '-';
          
          csvContent += `"${name}",${id},"${grade}","${dept}"\n`;
      });
      
      downloadCSV(csvContent, `‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô_${eventName}_${date}.csv`);
  };
}


/* =======================
   ‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°
======================= */
function getSubjects(){
    return JSON.parse(localStorage.getItem("subjects") || "[]");
}

function saveSubjects(subjects){
    localStorage.setItem("subjects", JSON.stringify(subjects));
}

function addSubject(){
  const name = document.getElementById("subjectName").value.trim();
  const code = document.getElementById("subjectCode").value.trim();
  const points = parseInt(document.getElementById("subjectPoints").value);

  if(!name || !code || isNaN(points)){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }

  let sub = getSubjects();
  if(sub.some(s => s.code === code)){
    alert("‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
    return;
  }
  
  sub.push({ name, code, points });
  saveSubjects(sub);

  document.getElementById("subjectName").value="";
  document.getElementById("subjectCode").value="";
  document.getElementById("subjectPoints").value="";

  renderSubjects();
}

function renderSubjects(){
  const list = document.getElementById("subjectList");
  const subjects = getSubjects();

  list.innerHTML="";

  if(subjects.length===0){
    list.innerHTML="<li class='list-group-item text-center text-muted'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤</li>";
    return;
  }

  subjects.forEach((s,i)=>{
    const li = document.createElement("li");
    li.className="list-group-item d-flex justify-content-between align-items-center";

    li.innerHTML = `
      <div>
        <strong class="text-primary">${s.name} (${s.code})</strong>
        <br>
        <small class="text-muted">‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏° ${s.points} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</small>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-primary" onclick="showSubjectDetail('${s.code}')">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteSubject(${i})">‡∏•‡∏ö</button>
      </div>
    `;

    list.appendChild(li);
  });
}

function deleteSubject(i){
  if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){
    let subjects = getSubjects();
    subjects.splice(i,1);
    saveSubjects(subjects);
    renderSubjects();
  }
}

/* ‚≠ê Modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ß‡∏¥‡∏ä‡∏≤ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV) */
function showSubjectDetail(code){
  const subjects = getSubjects();
  const logs = JSON.parse(localStorage.getItem("redeemLogs") || "[]");
  const students = JSON.parse(localStorage.getItem("students") || "[]");

  const sub = subjects.find(s => s.code === code);
  const filtered = logs.filter(l => l.subjectCode === code);

  document.getElementById("subCode").innerText = sub.code;
  document.getElementById("subName").innerText = sub.name;
  document.getElementById("subCount").innerText = filtered.length;

  const ul = document.getElementById("subList");
  ul.innerHTML="";

  filtered.forEach(item=>{
    const stu = students.find(s => s.id === item.studentID);
    const li = document.createElement("li");
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà (Grade, Dept) ‡∏î‡πâ‡∏ß‡∏¢
    const grade = stu ? stu.grade || '-' : '-';
    const dept = stu ? stu.dept || '-' : '-';

    li.textContent = stu
      ? `${stu.name} (${stu.id}) | ‡∏ä‡∏±‡πâ‡∏ô: ${grade}, ‡πÅ‡∏ú‡∏ô‡∏Å: ${dept}`
      : item.studentID;

    ul.appendChild(li);
  });

  new bootstrap.Modal(document.getElementById("subjectDetailModal")).show();

  // üÜï ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤
  document.getElementById("downloadSubjectRedeemBtn").onclick = () => {
      // NEW: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞ ‡πÅ‡∏ú‡∏ô‡∏Å
      const header = "‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô,‡πÅ‡∏ú‡∏ô‡∏Å,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å\n";
      let csvContent = header;

      filtered.forEach(item => {
          const stu = students.find(s => s.id === item.studentID);
          const name = stu ? stu.name : item.studentID;
          const grade = stu ? stu.grade || '-' : '-';
          const dept = stu ? stu.dept || '-' : '-';
          
          csvContent += `"${name}",${item.studentID},"${grade}","${dept}",${item.date}\n`;
      });
      
      downloadCSV(csvContent, `‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°_${sub.code}_${sub.name}.csv`);
  };
}

renderSubjects();

/* =======================
   ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
======================= */
function addStudent(){
  const name = document.getElementById("studentName").value.trim();
  const id   = document.getElementById("studentID").value.trim();
  const grade = document.getElementById("studentGrade").value.trim(); // NEW: ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô
  const dept = document.getElementById("studentDept").value.trim();   // NEW: ‡πÅ‡∏ú‡∏ô‡∏Å
  const dob  = document.getElementById("studentDOB").value.trim();

  // NEW: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö field ‡πÉ‡∏´‡∏°‡πà
  if(!name || !id || !grade || !dept || !dob){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }

  let students = JSON.parse(localStorage.getItem("students") || "[]");
  if(students.some(s=>s.id===id)){
    alert("‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥");
    return;
  }

  // NEW: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö grade ‡πÅ‡∏•‡∏∞ dept
  students.push({ name, id, grade, dept, dob });
  localStorage.setItem("students", JSON.stringify(students));

  document.getElementById("studentName").value="";
  document.getElementById("studentID").value="";
  document.getElementById("studentGrade").value=""; // NEW: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤
  document.getElementById("studentDept").value="";  // NEW: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤
  document.getElementById("studentDOB").value="";

  renderStudents();
}

function renderStudents(){
  const students = JSON.parse(localStorage.getItem("students") || "[]");
  const list = document.getElementById("studentList");

  list.innerHTML="";

  if(students.length===0){
    list.innerHTML="<li class='list-group-item text-center text-muted'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</li>";
    return;
  }

  students.forEach((s,i)=>{
    const li = document.createElement("li");
    li.className="list-group-item d-flex justify-content-between align-items-center";

    // NEW: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á grade ‡πÅ‡∏•‡∏∞ dept
    li.innerHTML = `
      <div>
        <strong class="text-primary">${s.name} (${s.id})</strong>
        <br>
        <small class="text-muted">‡∏ä‡∏±‡πâ‡∏ô: ${s.grade || '-'}, ‡πÅ‡∏ú‡∏ô‡∏Å: ${s.dept || '-'} - ‡πÄ‡∏Å‡∏¥‡∏î: ${s.dob || '-'}</small>
      </div>
      <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-primary" onclick="showStudentDetail('${s.id}')">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent(${i})">‡∏•‡∏ö</button>
      </div>
    `;

    list.appendChild(li);
  });
}

function deleteStudent(i){
  if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){
    let students = JSON.parse(localStorage.getItem("students") || "[]");
    students.splice(i,1);
    localStorage.setItem("students", JSON.stringify(students));
    renderStudents();
  }
}

/* üÜï Function: ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
function downloadAllStudentReport() {
    const students = JSON.parse(localStorage.getItem("students") || "[]");
    const redeemLogs = JSON.parse(localStorage.getItem("redeemLogs") || "[]");
    const events = getEvents();
    const registrations = getRegistrations();
    const subjects = getSubjects();
    
    // Header for the CSV (NEW: Added ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô and ‡πÅ‡∏ú‡∏ô‡∏Å)
    let csvContent = "‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô,‡πÅ‡∏ú‡∏ô‡∏Å,‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏Ñ‡∏£‡∏±‡πâ‡∏á),‡∏Ç‡∏≤‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏Ñ‡∏£‡∏±‡πâ‡∏á),‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏° (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô),‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å\n";

    students.forEach(student => {
        const studentId = student.id;
        
        // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î
        let attendedCount = 0;
        let missedCount = 0;
        
        Object.keys(events).forEach(date => {
            events[date].forEach((event, index) => {
                if (event.mode === 'register') {
                    const regKey = `${studentId}_${index}`;
                    const registered = (registrations[date] || []).includes(regKey);
                    
                    if (registered) {
                        attendedCount++;
                    } else {
                        // ‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≤‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                        missedCount++; 
                    }
                }
            });
        });

        // 2. ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏° (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Local Storage ‡∏ó‡∏µ‡πà index.html ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏ß‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
        const studentPoints = parseFloat(localStorage.getItem(`points_${studentId}`) || "0").toFixed(1);

        // 3. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å
        const studentRedeems = redeemLogs.filter(log => log.studentID === studentId);
        
        // Summarize redeemed subjects
        const redeemSummary = studentRedeems.reduce((acc, log) => {
            const sub = subjects.find(s => s.code === log.subjectCode);
            const subjectName = sub ? sub.name : `(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤: ${log.subjectCode})`;
            if (acc[subjectName]) {
                acc[subjectName]++;
            } else {
                acc[subjectName] = 1;
            }
            return acc;
        }, {});
        
        const redeemedList = Object.keys(redeemSummary).map(name => 
            `${name} (${redeemSummary[name]} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`
        ).join(' | ');

        // Add to CSV content (NEW: Added student.grade and student.dept)
        csvContent += `"${student.name}",${student.id},"${student.grade || '-'}"` +
                      `,"${student.dept || '-'}",${attendedCount},${missedCount},${studentPoints},${studentRedeems.length},"${redeemedList}"\n`;
    });

    downloadCSV(csvContent, `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°_${new Date().toISOString().slice(0, 10)}.csv`);
}

/* ‚≠ê Function: ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô */
function showStudentDetail(studentId){
    const students = JSON.parse(localStorage.getItem("students") || "[]");
    const redeemLogs = JSON.parse(localStorage.getItem("redeemLogs") || "[]");
    const events = getEvents();
    const registrations = getRegistrations();

    const student = students.find(s => s.id === studentId);

    if(!student) return;

    // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î
    let attendedCount = 0;
    let missedCount = 0;
    
    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
    Object.keys(events).forEach(date => {
        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô
        events[date].forEach((event, index) => {
            // ‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (register)
            if (event.mode === 'register') {
                const regKey = `${studentId}_${index}`; // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const registered = (registrations[date] || []).includes(regKey);
                
                if (registered) {
                    attendedCount++;
                } else {
                    missedCount++;
                }
            }
        });
    });

    // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°
    const studentPoints = parseFloat(localStorage.getItem(`points_${studentId}`) || "0").toFixed(1);

    // 3. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å
    const studentRedeems = redeemLogs.filter(log => log.studentID === studentId);
    const subjects = getSubjects();

    const redeemListUl = document.getElementById("stuRedeemList");
    redeemListUl.innerHTML = "";

    if (studentRedeems.length === 0) {
        redeemListUl.innerHTML = "<li class='list-group-item text-center text-muted'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤</li>";
    } else {
        // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        const redeemSummary = studentRedeems.reduce((acc, log) => {
            const sub = subjects.find(s => s.code === log.subjectCode);
            const subjectName = sub ? sub.name : `(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤: ${log.subjectCode})`;
            
            if (acc[subjectName]) {
                acc[subjectName].count++;
            } else {
                acc[subjectName] = { count: 1, points: sub ? sub.points : 0 };
            }
            return acc;
        }, {});

        Object.keys(redeemSummary).forEach(name => {
            const summary = redeemSummary[name];
            const li = document.createElement("li");
            li.textContent = `${name} (‡πÅ‡∏•‡∏Å‡πÑ‡∏õ ${summary.count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á) - ‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏ß‡∏° ${summary.count * summary.points} ‡πÅ‡∏ï‡πâ‡∏°`;
            redeemListUl.appendChild(li);
        });
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Modal (NEW: ‡πÄ‡∏û‡∏¥‡πà‡∏° grade ‡πÅ‡∏•‡∏∞ dept)
    document.getElementById("stuDetailName").innerText = `${student.name} (${student.id}) ‡∏ä‡∏±‡πâ‡∏ô: ${student.grade || '-'} ‡πÅ‡∏ú‡∏ô‡∏Å: ${student.dept || '-'}`;
    document.getElementById("stuAttendedCount").innerText = attendedCount;
    document.getElementById("stuMissedCount").innerText = missedCount;
    document.getElementById("stuPointCount").innerText = studentPoints;
    document.getElementById("stuRedeemTotal").innerText = studentRedeems.length;


    new bootstrap.Modal(document.getElementById("studentDetailModal")).show();
}

/* =======================
   Import CSV
======================= */
function importStudentsCSV(){
  const file = document.getElementById("studentCSV").files[0];
  if(!file){
    alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    const lines = e.target.result.split(/\r?\n/);
    let students = JSON.parse(localStorage.getItem("students") || "[]");
    let added = 0;

    lines.forEach((line,i)=>{
      if(i===0) return;
      
      // NEW: ‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á 5 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: name, id, grade, dept, dob
      const parts = line.split(",").map(x=>x.trim().replace(/^"|"$/g, '')); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Excel)
      if (parts.length < 5) return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 5 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå

      const name = parts[0];
      const id = parts[1];
      const grade = parts[2]; // NEW
      const dept = parts[3];  // NEW
      const dob = parts[4];
      
      // NEW: ‡πÄ‡∏û‡∏¥‡πà‡∏° grade ‡πÅ‡∏•‡∏∞ dept ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      if(name && id && grade && dept && dob && !students.some(s=>s.id===id)){ 
        students.push({ name, id, grade, dept, dob }); 
        added++;
      }
    });

    localStorage.setItem("students", JSON.stringify(students));
    renderStudents();
    alert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${added} ‡∏Ñ‡∏ô\n\n**‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏**: ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö CSV ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏Ñ‡∏∑‡∏≠: ‡∏ä‡∏∑‡πà‡∏≠,‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô,‡πÅ‡∏ú‡∏ô‡∏Å,‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î`);
  };

  reader.readAsText(file,"UTF-8");
}

renderStudents();

</script>

</body>
</html>





